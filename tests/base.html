<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{% block title %}LuftDocs{% endblock %}</title>

    <link rel="shortcut icon" href="{{ url_for('static', filename='assets/icon2.png') }}" type="image/png">
    <link rel="icon" href="{{ url_for('static', filename='assets/icon2.png') }}" sizes="32x32" type="image/png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="highlight-theme-style">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.5/viewer.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
     /* --- VARIÁVEIS GLOBAIS --- */
     :root {
         --font-size-base: 1rem;
         --bg-color: #f9f9fb;
         --text-color: #212529;
         --surface-bg: #ffffff;
         --surface-color: #23263b;
         --accent-color: #1a237e;
         --border-color: #dee2e6;
         --shadow-color: #0000000d;
     }

     /* --- TEMA ESCURO --- */
     body.theme-dark {
         --bg-color: #1e1e1e;
         --text-color: #e7eaf1;
         --surface-bg: #2b2b3a;
         --surface-color: #f8f9fa;
         --accent-color: #f5f5f5;
         --border-color: #444444;
         --shadow-color: #00000026;
     }

     /* --- ESTILOS BASE --- */
     body {
         background-color: var(--bg-color);
         color: var(--text-color);
         font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
         font-size: var(--font-size-base);
         margin: 0;
         transition: background-color 0.3s, color 0.3s, font-size 0.3s;
     }
     
     /* --- LAYOUT --- */
     .navbar, .footer-LuftDocs {
         background-color: var(--surface-bg);
         color: var(--surface-color);
         padding: 1rem clamp(1rem, 4vw, 6rem);
         box-shadow: 0 2px 12px var(--shadow-color);
         transition: background-color 0.3s, color 0.3s;
     }

     .navbar {
         display: flex;
         justify-content: space-between;
         align-items: center;
         flex-wrap: wrap;
         gap: 1rem;
     }
     
     .main {
         padding: 2rem clamp(1rem, 4vw, 6rem);
         max-width: 1200px;
         margin: 0 auto;
     }

     .footer-LuftDocs {
         margin-top: 31rem;
         padding-top: 2.5rem;
         padding-bottom: 2.5rem;
         text-align: center;
         box-shadow: 0 -2px 10px var(--shadow-color);
     }
     
     /* --- COMPONENTES --- */
     .logo-wiki {
         color: var(--surface-color);
         font-size: 1.35rem;
         font-weight: 700;
         text-decoration: none;
         transition: color 0.15s;
     }
     .logo-wiki:hover { color: #0d6efd; }

     .modulo-conteudo img, .modulo-conteudo video {
         max-width: 440px;
         width: 100%;
         height: auto;
         display: block;
         margin: 1.5rem auto;
         border-radius: 12px;
         box-shadow: 0 2px 10px var(--shadow-color);
         transition: box-shadow 0.2s, filter 0.2s;
         cursor: pointer;
     }
     .modulo-conteudo img:hover, .modulo-conteudo video:hover {
         box-shadow: 0 6px 24px #00b4d820, 0 2px 12px #0000001a;
         filter: brightness(1.04);
     }
     
     /* --- ESTILOS PARA IA FLUTUANTE --- */
     #lia-fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 1055;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
     }

     #liaChatModal .modal-body {
        background-color: #f8f9fa;
     }
     body.theme-dark #liaChatModal .modal-body {
        background-color: #1e1e1e;
     }

     #iaResponse {
        min-height: 200px;
        max-height: 50vh;
        overflow-y: auto;
     }
     #iaResponse img { 
        max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; border: 1px solid #dee2e6; 
     }
     #context-files { 
        font-size: 0.8rem; max-height: 150px; overflow-y: auto; background-color: #e9ecef; 
     }
     body.theme-dark #context-files {
        background-color: #333;
     }

     /* --- ALTERAÇÃO: CSS para forçar a centralização global do Modal da IA --- */
     #liaChatModal.modal.show {
        display: flex !important;
        justify-content: center;
        align-items: center;
     }
     /* --------------------------------------------------------------------- */

    /* --- NOVO LAYOUT MODERNO PARA O MODAL DA IA --- */
    #liaChatModal .modal-content {
        /* Removemos a cor padrão para um efeito de vidro no fundo */
        background-color: transparent;
        border: none;
        box-shadow: none;
    }

    #liaChatModal .modal-body {
        padding: 0;
        display: flex;
        flex-direction: column;
        /* Altura do modal, pode ajustar conforme preferir */
        height: 75vh; 
        max-height: 800px;
        background-color: var(--bg-color); /* Fundo principal do modal */
        border-radius: 1rem; /* Bordas mais arredondadas */
        border: 1px solid var(--border-color);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.18);
        overflow: hidden; /* Garante que os filhos respeitem as bordas arredondadas */
    }

    /* Área principal da conversa */
    #iaResponse {
        flex-grow: 1; /* Faz a área de resposta ocupar todo o espaço disponível */
        overflow-y: auto; /* Habilita a rolagem apenas na área de respostas */
        padding: 1.5rem;
        scroll-behavior: smooth;
    }

    /* Estilizando o conteúdo gerado pelo Markdown para parecerem "balões" de chat */
    #iaResponse h2 {
        font-size: 1.1rem;
        padding-bottom: 0.5rem;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
        color: var(--accent-color);
    }
    #iaResponse p {
        line-height: 1.6;
        margin-bottom: 1rem;
    }
    #iaResponse strong {
        color: var(--accent-color);
    }
    #iaResponse ul {
        padding-left: 25px;
    }
    #iaResponse img {
        border-radius: 0.75rem !important; /* Bordas mais suaves na imagem */
        margin: 1rem 0;
    }

    /* Define um tamanho máximo para as imagens dentro dos balões de mensagem */
    #liaResponseContainer .lia-message img {
        max-width: 450px; /* <<-- Altere este valor como quiser */
        height: auto;
        display: block;
        margin: 1rem auto; /* Centraliza a imagem */
        border-radius: 12px; /* Adiciona bordas arredondadas à imagem */
    }

    /* Garante que o conteúdo de texto dentro do balão não seja afetado */
    #liaResponseContainer .lia-message p {
        margin-bottom: 0.5rem; /* Ajusta o espaçamento entre parágrafos */
    }


    /* Barra de input inferior */
    .lia-chat-footer {
        padding: 1rem 1.5rem;
        background-color: var(--surface-bg); /* Usa a cor de "superfície" para destacar a área de input */
        border-top: 1px solid var(--border-color);
        box-shadow: 0 -4px 15px rgba(0,0,0,0.05);
    }
    body.theme-dark .lia-chat-footer {
        box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
    }

    /* Ajustes finos nos controles de input */
    .lia-chat-footer .form-label {
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }
    .lia-chat-footer .form-control, .lia-chat-footer .form-select {
        background-color: var(--bg-color); /* Inputs com a cor de fundo principal */
    }

    /* Container para a área de input, para posicionar a lista de autocomplete */
    .lia-chat-footer .input-wrapper {
        position: relative;
    }

    #liaModulesList {
        position: absolute;
        bottom: 100%; /* Posiciona a lista ACIMA do input */
        left: 0;
        right: 0;
        z-index: 1060; /* Garante que fique acima de outros elementos do modal */
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        background-color: var(--surface-bg);
        box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
        margin-bottom: 0.5rem;
    }

    #liaModulesList .list-group-item {
        background-color: transparent;
        border: none;
        transition: background-color 0.15s;
    }

    #liaModulesList .list-group-item:hover,
    #liaModulesList .list-group-item.active {
        background-color: rgba(13, 110, 253, 0.1);
        color: var(--text-color);
    }   

    /* --- Layout Moderno para o Contexto da IA --- */
    #context-info {
        border-top: 1px solid var(--border-color);
        padding-top: 0.75rem;
        margin-top: 0.75rem;
    }

    #context-info .btn-context {
        text-decoration: none;
        font-weight: 500;
        font-size: 0.85rem;
        color: var(--text-color);
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    #context-info .btn-context:hover {
        opacity: 1;
    }

    /* Animação do ícone de seta */
    #context-info .btn-context .bi-chevron-down {
        transition: transform 0.3s ease;
    }
    #context-info .btn-context[aria-expanded="true"] .bi-chevron-down {
        transform: rotate(180deg);
    }

    #context-files {
        background-color: transparent !important; /* Remove fundo que vinha do estilo antigo */
        padding: 0.5rem 0 0 0 !important;
        font-size: 0.8rem;
    }

    #context-files .list-group-item {
        background-color: rgba(128, 128, 128, 0.1);
        border-radius: 4px;
        margin-bottom: 4px;
        border: none;
        padding: 0.25rem 0.5rem;
        color: var(--text-color);
    }

     /* --- OVERRIDES TEMA ESCURO --- */
     body.theme-dark .card,
     body.theme-dark .modal-content,
     body.theme-dark .dropdown-menu {
         background-color: var(--surface-bg);
         color: var(--text-color);
         border-color: var(--border-color);
     }
     body.theme-dark .text-body,
     body.theme-dark .dropdown-item,
     body.theme-dark .form-check-label {
         color: var(--text-color) !important;
     }
     body.theme-dark .text-primary { color: var(--accent-color) !important; }
     body.theme-dark .text-dark { color: var(--surface-color) !important; }

     body.theme-dark .btn-outline-dark {
         color: var(--surface-color);
         border-color: var(--surface-color);
     }
     body.theme-dark .btn-outline-dark:hover {
         color: var(--surface-bg);
         background-color: var(--surface-color);
     }
     body.theme-dark .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

     body.theme-dark .nav-tabs .nav-link {
         background-color: var(--surface-bg);
         color: var(--text-color);
         border-color: var(--border-color);
     }
     body.theme-dark .nav-tabs .nav-link.active { background-color: #3a3a4a; }

     body.theme-dark .form-select,
     body.theme-dark .form-check-input {
         background-color: #1e1e1e;
         color: var(--text-color);
         border-color: var(--border-color);
     }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="{{ url_for('index.index', token=request.args.get('token')) }}" class="logo-wiki d-flex align-items-center">
            <img src="{{ url_for('static', filename='assets/icon2.png') }}" alt="LuftDocs Logo" width="50" height="50" class="me-2">
            <span>LuftDocs</span>
        </a>
        <div class="d-flex align-items-center">
            
            <a href="{{ url_for('search.perform_search', token=request.args.get('token')) }}"  class="btn btn-outline-dark fw-bold me-3">
                <i class="bi bi-search"></i>
                <span class="d-none d-sm-inline">Buscar</span>
            </a>
            
            <div class="dropdown">
                <a class="btn btn-link text-dark p-0 dropdown-toggle text-decoration-none" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle" style="font-size: 1.8rem;"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalMinhaConta"><i class="bi bi-person-badge me-2"></i>Minha Conta</a></li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalConfiguracoes"><i class="bi bi-gear me-2"></i>Configurações</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('index.logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="page-wrapper">
        <main class="main" id="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>
    
    <button id="lia-fab" class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#liaChatModal" title="Perguntar para a Lia">
        <i class="bi bi-stars"></i>
    </button>

    <div class="modal fade" id="modalMinhaConta" tabindex="-1" aria-labelledby="modalMinhaContaLabel" aria-hidden="true">
        </div>

    <div class="modal fade" id="modalConfiguracoes" tabindex="-1" aria-labelledby="modalConfigLabel" aria-hidden="true">
       </div>
    
    <div class="modal fade" id="modalDev" tabindex="-1" aria-labelledby="modalDevLabel" aria-hidden="true">
        </div>

    <div class="modal fade" id="liaChatModal" tabindex="-1" aria-labelledby="liaChatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    
                    <div id="iaResponse">
                        <p class="text-muted">A resposta da Lia aparecerá aqui...</p>
                    </div>

                    <div class="lia-chat-footer">
                        <div class="row g-3 align-items-end">
                            <div class="col">
                                <label for="userQuestion" class="form-label">Sua Pergunta:</label>
                                
                                <div class="input-wrapper" style="position: relative;">
                                    
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="userQuestion" placeholder="Como funciona a devolução? Use @ para focar...">
                                        
                                        <button class="btn btn-outline-secondary" type="button" id="liaModulesHelperBtn" title="Mencionar módulo">
                                            <i class="bi bi-at"></i>
                                        </button>
                                    </div>
                                    
                                    <div id="liaModulesList" class="list-group" style="display: none; position: absolute; bottom: 100%; left: 0; right: 0; z-index: 10; max-height: 160px; overflow-y: auto; margin-bottom: 0.5rem; box-shadow: 0 -4px 15px rgba(0,0,0,0.1);">
                                        </div>

                                </div>
                            </div>

                            <div class="col-md-4">
                                <label for="modelSelector" class="form-label">Modelo da IA:</label>
                                <select class="form-select" id="modelSelector">
                                    <option value="groq-70b" selected>Groq (Llama 3 70b)</option>
                                    <option value="groq-8b">Groq (Llama 3 8b)</option>
                                    <option value="gemini">Gemini (1.5 Flash)</option>
                                    <option value="openai" disabled>OpenAI (GPT-4o)</option>
                                </select>
                            </div>

                            <div class="col-auto">
                                <button class="btn btn-primary btn-lg" id="askButton" style="width: 120px;">
                                    <span id="spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                    Enviar
                                </button>
                            </div>
                        </div>
                        
                        {% if can_view_tecnico %}
                            <div id="context-info" class="mt-2" style="display: none;">
                                <a class="btn-context" data-bs-toggle="collapse" href="#liaContextCollapse" role="button" aria-expanded="false" aria-controls="liaContextCollapse">
                                    Fontes utilizadas
                                    <i class="bi bi-chevron-down ms-1"></i>
                                </a>
                                <div class="collapse" id="liaContextCollapse">
                                    <div id="context-files" class="list-group list-group-flush p-2"></div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
        
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
       </div>
    
    {% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.5/viewer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://unpkg.com/cytoscape-cola/cytoscape-cola.js"></script>
    <script>
// ===============================================
// === INÍCIO DO BLOCO DE SCRIPT ATUALIZADO DA IA ===
// ===============================================

const askButton = document.getElementById('askButton');
const userQuestionInput = document.getElementById('userQuestion');
const modelSelector = document.getElementById('modelSelector');
const iaResponseDiv = document.getElementById('iaResponse');
const spinner = document.getElementById('spinner');
// Elementos que podem não existir dependendo da permissão
const contextInfo = document.getElementById('context-info');
const contextFilesDiv = document.getElementById('context-files');

if (askButton) {
    // --- LÓGICA DE AUTOCOMPLETE DE MÓDULOS ---
    const modulesHelperBtn = document.getElementById('liaModulesHelperBtn');
    const modulesListDiv = document.getElementById('liaModulesList');
    let modulesCache = [];
    let isListVisible = false;

const fetchModules = async () => {
    if (modulesCache.length > 0) return modulesCache;
    try {
        const response = await fetch("{{ url_for('ia_bp.get_modules_list') }}");
        if (!response.ok) return [];
        const data = await response.json();
        modulesCache = data.modules;
        return modulesCache;
    } catch (error) {
        console.error("Erro ao buscar lista de módulos:", error);
        return [];
    }
};

const showModulesList = (filter = '') => {
    fetchModules().then(modules => {
        const filteredModules = modules.filter(m => m.toLowerCase().includes(filter.toLowerCase()));
        if (filteredModules.length === 0) {
            hideModulesList();
            return;
        }
        
        modulesListDiv.innerHTML = '';
        filteredModules.forEach(module => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action py-2 px-3';
            item.textContent = `@${module}`;
            item.onclick = (e) => {
                e.preventDefault();
                const currentText = userQuestionInput.value;
                const atIndex = currentText.lastIndexOf('@');
                userQuestionInput.value = currentText.substring(0, atIndex) + `@${module} `;
                hideModulesList();
                userQuestionInput.focus();
            };
            modulesListDiv.appendChild(item);
        });
        modulesListDiv.style.display = 'block';
        isListVisible = true;
    });
};

const hideModulesList = () => {
    modulesListDiv.style.display = 'none';
    isListVisible = false;
};

if (modulesHelperBtn) {
    // Evento de clique no botão de ajuda '@'
    modulesHelperBtn.addEventListener('click', () => {
        if (isListVisible) {
            hideModulesList();
        } else {
            const currentValue = userQuestionInput.value;
            // Adiciona '@' de forma inteligente (com espaço se necessário)
            if (currentValue.length > 0 && !currentValue.endsWith(' ')) {
                userQuestionInput.value += ' @';
            } else {
                userQuestionInput.value += '@';
            }
            userQuestionInput.focus();
            showModulesList();
        }
    });

    // Evento de digitação no input principal para o autocomplete
    userQuestionInput.addEventListener('input', () => {
        const currentText = userQuestionInput.value;
        const atIndex = currentText.lastIndexOf('@');

        if (atIndex !== -1 && !currentText.includes(' ', atIndex)) {
            const searchTerm = currentText.substring(atIndex + 1);
            showModulesList(searchTerm);
        } else {
            hideModulesList();
        }
    });
    
    // Esconder a lista se clicar fora dela
    document.addEventListener('click', (e) => {
        if (!modulesListDiv.contains(e.target) && e.target !== userQuestionInput && e.target !== modulesHelperBtn && !modulesHelperBtn.contains(e.target)) {
            hideModulesList();
        }
    });
}

    // --- LÓGICA PRINCIPAL PARA ENVIAR A PERGUNTA ---
    askButton.addEventListener('click', async () => {
        const userQuestion = userQuestionInput.value;
        const selectedModel = modelSelector.value;

        if (!userQuestion.trim()) {
            alert('Por favor, faça uma pergunta.');
            return;
        }

        spinner.style.display = 'inline-block';
        askButton.disabled = true;
        iaResponseDiv.innerHTML = `<p class="text-muted">A Lia está pensando com o motor do ${selectedModel.toUpperCase()}...</p>`;
        
        // Verificação de segurança para o contextInfo
        if (contextInfo) {
            contextInfo.style.display = 'none';
        }

        try {
            const response = await fetch('/api/ask_llm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    user_question: userQuestion,
                    selected_model: selectedModel 
                }),
            });

            const data = await response.json();

            if (response.ok) {
                iaResponseDiv.innerHTML = marked.parse(data.answer); 
                // Verificação de segurança para o contextInfo e contextFilesDiv
                if (contextInfo && contextFilesDiv && data.context_files && data.context_files.length > 0) {
                    contextFilesDiv.innerHTML = '';
                    data.context_files.forEach(file => {
                        const fileElement = document.createElement('div');
                        fileElement.className = 'list-group-item py-1';
                        fileElement.textContent = file;
                        contextFilesDiv.appendChild(fileElement);
                    });
                    contextInfo.style.display = 'block';
                }
            } else {
                iaResponseDiv.innerHTML = `<p class="text-danger"><strong>Erro:</strong> ${data.error}</p>`;
            }
        } catch (error) {
            iaResponseDiv.innerHTML = `<p class="text-danger"><strong>Erro de conexão.</strong> Verifique o console do servidor.</p>`;
            console.error("Erro na chamada da API da IA:", error);
        } finally {
            spinner.style.display = 'none';
            askButton.disabled = false;
        }
    });

    // Limpeza do modal ao fechar
    const liaModalElement = document.getElementById('liaChatModal');
    if (liaModalElement) {
        liaModalElement.addEventListener('hidden.bs.modal', () => {
            userQuestionInput.value = '';
            iaResponseDiv.innerHTML = '<p class="text-muted">A resposta aparecerá aqui...</p>';
            
            // Verificação de segurança para o contextInfo
            if (contextInfo) {
                contextInfo.style.display = 'none';
                if (contextFilesDiv) {
                    contextFilesDiv.innerHTML = '';
                }
                const collapseElement = document.getElementById('liaContextCollapse');
                if (collapseElement && collapseElement.classList.contains('show')) {
                    const bsCollapse = bootstrap.Collapse.getInstance(collapseElement) || new bootstrap.Collapse(collapseElement, {toggle: false});
                    bsCollapse.hide();
                }
            }
        });
    }
}

// =============================================
// === FIM DO BLOCO DE SCRIPT ATUALIZADO DA IA ===
// =============================================
    </script>
    {% endblock %}
</body>
<footer class="footer-LuftDocs">
    LuftDocs &copy; 2025 — Feito para facilitar seu dia a dia.
</footer>
</html>