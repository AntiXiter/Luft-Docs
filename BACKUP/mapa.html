{% extends "base.html" %}
{% block title %}LuftDocs - Mapa de Conhecimento Dinâmico{% endblock %}

{% block content %}
{# ====================================================================== #}
{# CABEÇALHO COM BOTÕES E FILTRO #}
{# ====================================================================== #}
<div class="container my-5">
    <div class="mb-4 text-end d-flex justify-content-end gap-2">
        <a href="{{ url_for('index.index', token=request.args.get('token')) }}" id="switchToCardViewBtn" class="btn btn-primary modern-btn">
            <i class="bi bi-grid-3x3-gap"></i> Ver Cards
        </a>
        {% if can_access_editor %}
        <a href="{{ url_for('editor.editor_index', token=request.args.get('token')) }}" class="btn btn-outline-dark modern-btn">
            <i class="bi bi-pencil-square"></i> Acessar editor
        </a>
        {% endif %}
        {% if can_access_permissions_menu %}
        <a href="{{ url_for('permissions.manage_permissions', token=request.args.get('token')) }}" class="btn btn-outline-dark modern-btn">
            <i class="bi bi-shield-lock"></i> Gerenciar permissões
        </a>
        {% endif %}
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="Title mb-0">Mapa de Conhecimento</h1>
        <div class="position-relative" style="min-width: 250px;">
            <input type="text" id="filterInput" class="form-control ps-4" placeholder="Filtrar módulos...">
            <i class="bi bi-search position-absolute top-50 translate-middle-y" style="left: 10px; color: #6c757d;"></i>
        </div>
    </div>
</div>

{# ====================================================================== #}
{# CONTAINER PARA O GRÁFICO D3.JS #}
{# ====================================================================== #}
<div class="container-mapa pb-5">
    <div id="graph-container" class="graph-container">
        </div>
    <div id="no-results-message" class="col-12 text-center py-5" style="display: none;">
        <i class="bi bi-emoji-frown fs-1 text-muted"></i>
        <h4 class="mt-3">Nenhum módulo encontrado</h4>
    </div>
</div>

<style>
    /* CSS ATUALIZADO PARA O MÉTODO COM ÍCONES BOOTSTRAP */
    body {
        perspective: 1500px;
    }
    .graph-container {
        border-radius: 1.25rem;
        background: var(--card-bg, #fff);
        box-shadow: 0 8px 32px rgba(80, 120, 200, 0.12);
        border: 1.5px solid var(--border-color, #e3e6ed);
        width: 100%;
        height: 75vh;
        min-height: 600px;
        position: relative;
        cursor: grab;
    }
    body.theme-dark .graph-container {
        background: var(--dark-card-bg, #23263b);
        border-color: #23263b;
    }

    /* Estilo dos links (conexões) */
    .link {
        stroke: #999;
        stroke-opacity: 0.6;
        transition: stroke-opacity 0.3s;
    }
    .link.faded { stroke-opacity: 0.1; }

    /* Estilo do Grupo do Nó */
    .node { cursor: pointer; transition: opacity 0.3s; }
    .node.faded { opacity: 0.2; }

    /* Círculo de fundo do nó */
    .node-background {
        fill: var(--card-bg, #f8f9fa);
        stroke: #ccc;
        stroke-width: 1.5px;
        transition: transform 0.2s ease-out, filter 0.2s, fill 0.2s;
    }
    body.theme-dark .node-background {
        fill: #2d325a;
        stroke: #444;
    }
    .node:hover .node-background {
        transform: scale(1.1);
        filter: drop-shadow(0 0 6px var(--primary-accent-color, #0d6efd));
    }
    .node.filtered .node-background {
        stroke: #ffc107;
        stroke-width: 4px;
    }
    .node.related .node-background {
        stroke: #0dcaf0;
        stroke-width: 3px;
    }
    
    /* Estilos para o container do ícone (foreignObject) */
    .foreign-icon-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px; /* Tamanho do ícone */
        color: var(--primary-accent-color, #0d6efd);
        pointer-events: none; /* Impede que o ícone bloqueie eventos de drag */
    }

    /* Estilo do texto (nome do módulo) */
    .node-label {
        pointer-events: none;
        font-size: 13px;
        font-weight: 600;
        fill: var(--text-color, #333);
        text-shadow: 0 1px 3px var(--card-bg, #fff), 0 -1px 3px var(--card-bg, #fff), 1px 0 3px var(--card-bg, #fff), -1px 0 3px var(--card-bg, #fff);
    }
    body.theme-dark .node-label {
        fill: #eee;
        text-shadow: 0 1px 3px #23263b, 0 -1px 3px #23263b, 1px 0 3px #23263b, -1px 0 3px #23263b;
    }

    /* {# NOVO: ESTILOS PARA O MENU DE CONTEXTO #} */
    .context-menu {
        position: absolute;
        z-index: 1000;
        min-width: 200px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        border-radius: .5rem;
    }
    /* Usamos as classes do Bootstrap .list-group, mas podemos customizar se necessário */
    .context-menu .list-group-item {
        font-weight: 500;
    }

    /* Estilos da animação de transição (mantidos) */
    .container, .container-mapa { opacity: 0; transform: rotateY(90deg) scale(0.9); transition: transform 1s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.8s ease-in; }
    body.page-transition-in .container, body.page-transition-in .container-mapa { opacity: 1; transform: rotateY(0deg) scale(1); }
    body.page-transition-out .container, body.page-transition-out .container-mapa { opacity: 0; transform: rotateY(-90deg) scale(0.9); transition: transform 1s cubic-bezier(0.55, 0.085, 0.68, 0.53), opacity 0.8s ease-out; }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}

{# Passando os dados dos módulos para o JS #}
<script id="modulos-data" type="application/json">{{ modulos|tojson }}</script>

{# IMPORTANDO A BIBLIOTECA D3.JS #}
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // ======================================================================
    // 1. SETUP INICIAL E PREPARAÇÃO DOS DADOS
    // ======================================================================
    
    const nodeRadius = 40;
    const nodeCollideRadius = 50;
    const transitionDuration = 1000;

    const graphContainer = document.getElementById('graph-container');
    const filterInput = document.getElementById('filterInput');
    const noResultsMessage = document.getElementById('no-results-message');
    const switchToCardViewBtn = document.getElementById('switchToCardViewBtn');

    const rawModules = JSON.parse(document.getElementById('modulos-data').textContent);
    const token = new URLSearchParams(window.location.search).get('token');
    const width = graphContainer.clientWidth;
    const height = graphContainer.clientHeight;
    
    if (rawModules.length === 0) return;

    // Assumindo que o backend envia 'tem_modulo_tecnico'
    const nodes = rawModules.map(m => ({ ...m }));
    const links = [];
    rawModules.forEach(m => {
        if (m.relacionados_visiveis) {
            m.relacionados_visiveis.forEach(rel_id => {
                if (nodes.some(n => n.id === rel_id)) {
                    links.push({ source: m.id, target: rel_id });
                }
            });
        }
    });

    const initialRadius = Math.max(width, height) * 0.02;
    nodes.forEach(node => {
        const angle = Math.random() * 1.1 * Math.PI;
        node.x = width / 1.1 + initialRadius * Math.cos(angle);
        node.y = height / 1.1 + initialRadius * Math.sin(angle);
    });

    // ======================================================================
    // 2. CONFIGURAÇÃO DA SIMULAÇÃO DE FORÇA (A "GRAVIDADE")
    // ======================================================================
    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120).strength(0.5))
        .force("charge", d3.forceManyBody().strength(-100))
        .force("center", d3.forceCenter(width / 2, height / 2).strength(0.1))
        .force("collide", d3.forceCollide().radius(nodeCollideRadius));

    // ======================================================================
    // 3. RENDERIZAÇÃO DOS ELEMENTOS GRÁFICOS (SVG)
    // ======================================================================
    const svg = d3.create("svg")
        .attr("viewBox", [0, 0, width, height])
        .attr("width", width)
        .attr("height", height)
        .attr("style", "max-width: 100%; height: auto;");

    const g = svg.append("g");

    const link = g.append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("class", "link");

    const node = g.append("g")
        .attr("class", "nodes")
        .selectAll("g")
        .data(nodes)
        .join("g")
        .attr("class", "node");

    node.append("circle")
        .attr("r", nodeRadius)
        .attr("class", "node-background");

    node.append("foreignObject")
        .attr('width', nodeRadius * 2)
        .attr('height', nodeRadius * 2)
        .attr('x', -nodeRadius)
        .attr('y', -nodeRadius)
        .html(d => `
            <div class="foreign-icon-wrapper">
                <i class="bi ${d.icone || 'bi-record-circle'}"></i>
            </div>
        `);

    node.append("text")
        .attr("class", "node-label")
        .text(d => d.nome)
        .attr("x", 0)
        .attr("y", nodeRadius + 18)
        .attr("text-anchor", "middle");

    graphContainer.append(svg.node());

    // ======================================================================
    // 4. DEFINIÇÃO DA INTERATIVIDADE (DRAG, ZOOM, CLICK)
    // ======================================================================
    const drag = d3.drag()
        .on("start", (event, d) => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x; d.fy = d.y;
        })
        .on("drag", (event, d) => {
            d.fx = event.x; d.fy = event.y;
        })
        .on("end", (event, d) => {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null; d.fy = null;
        });
    
    node.call(drag);

    // // MODIFICADO: Lógica de clique para abrir o menu de contexto
    node.on("click", (event, d) => {
        console.log("Dados do nó clicado:", d); // <-- ADICIONE ESTA LINHA
        event.stopPropagation(); // Impede que o clique no nó feche o menu imediatamente
        showContextMenu(event, d);
    });

    const zoom = d3.zoom().scaleExtent([0.1, 4]).on("zoom", (event) => {
        g.attr("transform", event.transform);
    });
    svg.call(zoom);

    // // NOVO: Função para criar e mostrar o menu de contexto
    function showContextMenu(event, d) {
        // Remove qualquer menu existente
        d3.select('.context-menu').remove();

        const menuItems = [];
        
        // Adiciona a opção padrão
        menuItems.push({
            label: 'Abrir Módulo Padrão',
            url: `/modulo/?modulo=${d.id}&token=${token}`
        });

        // Adiciona a opção técnica, se existir
        if (true) { // <-- FORÇA A OPÇÃO TÉCNICA A SEMPRE APARECER (PARA TESTE)
            menuItems.push({
                label: 'Abrir Módulo Técnico',
                url: `/modulo/?modulo_tecnico=${d.id}&token=${token}`
            });
        }
        
        // Se houver apenas uma opção, redireciona direto
        if (menuItems.length === 1) {
            window.location.href = menuItems[0].url;
            return;
        }

        // Cria o menu
        const menu = d3.select('body').append('div')
            .attr('class', 'context-menu list-group')
            .style('left', `${event.pageX}px`)
            .style('top', `${event.pageY}px`);

        menu.selectAll('a')
            .data(menuItems)
            .enter()
            .append('a')
            .attr('href', item => item.url)
            .attr('class', 'list-group-item list-group-item-action')
            .html(item => `<i class="bi bi-box-arrow-up-right me-2"></i>${item.label}`);
    }

    // // NOVO: Evento para fechar o menu ao clicar em qualquer outro lugar
    d3.select('body').on('click', () => {
        d3.select('.context-menu').remove();
    });


    // ======================================================================
    // 5. LÓGICA DE FILTRO AVANÇADO
    // ======================================================================
    filterInput.addEventListener('input', () => {
        const filterText = filterInput.value.toLowerCase().trim();

        if (!filterText) {
            node.classed("faded", false).classed("filtered", false).classed("related", false);
            link.classed("faded", false);
            noResultsMessage.style.display = 'none';
            graphContainer.style.display = 'block';
            return;
        }

        const matchedNodes = new Set();
        nodes.forEach(n => {
            if (n.nome.toLowerCase().includes(filterText) || n.descricao.toLowerCase().includes(filterText)) {
                matchedNodes.add(n.id);
            }
        });

        const relatedNodes = new Set();
        if (matchedNodes.size > 0) {
            links.forEach(l => {
                if (matchedNodes.has(l.source.id)) relatedNodes.add(l.target.id);
                if (matchedNodes.has(l.target.id)) relatedNodes.add(l.source.id);
            });
        }
        
        const visibleNodes = new Set([...matchedNodes, ...relatedNodes]);

        node.classed("faded", d => !visibleNodes.has(d.id));
        node.classed("filtered", d => matchedNodes.has(d.id));
        node.classed("related", d => relatedNodes.has(d.id) && !matchedNodes.has(d.id));
        link.classed("faded", d => !(visibleNodes.has(d.source.id) && visibleNodes.has(d.target.id)));

        const hasVisibleNodes = visibleNodes.size > 0;
        noResultsMessage.style.display = hasVisibleNodes ? 'none' : 'block';
        graphContainer.style.display = hasVisibleNodes ? 'block' : 'none';
    });
    
    // ======================================================================
    // 6. FUNÇÃO 'TICK' E ANIMAÇÕES DE TRANSIÇÃO
    // ======================================================================
    simulation.on("tick", () => {
        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    setTimeout(() => { document.body.classList.add('page-transition-in'); }, 10);

    switchToCardViewBtn.addEventListener('click', (event) => {
        event.preventDefault();
        const destinationUrl = switchToCardViewBtn.href;
        document.body.classList.remove('page-transition-in');
        document.body.classList.add('page-transition-out');
        setTimeout(() => { window.location.href = destinationUrl; }, transitionDuration);
    });
});
</script>
{% endblock %}