{% extends "base.html" %}

{% block content %}
<style>
    /* ============================================
    == CSS Integrado com as Cores do base.html ==
    ==         (Suporte a Dark Mode)           ==
    ============================================ */

    /* Importa uma fonte moderna */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    
    /* Contêiner que envolve nossa página, usando as variáveis do seu tema */
    .evaluation-body-wrapper {
        font-family: 'Poppins', sans-serif;
        background-color: var(--bg-color); /* << USA SUA VARIÁVEL */
        margin: 0;
        padding: 2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 100px);
        transition: background-color 0.4s ease;
    }

    /* Card principal usando as cores de superfície do seu tema */
    .evaluation-container {
        background-color: var(--surface-bg); /* << USA SUA VARIÁVEL */
        border: 1px solid var(--border-color); /* << USA SUA VARIÁVEL */
        box-shadow: 0 10px 30px var(--shadow-color); /* << USA SUA VARIÁVEL */
        border-radius: 16px;
        padding: 2.5rem 3rem;
        width: 100%;
        max-width: 750px;
        text-align: center;
        opacity: 0;
        transform: translateY(30px);
        animation: fadeInUp 1s ease 0.2s forwards;
        transition: background-color 0.4s ease, border-color 0.4s ease;
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .evaluation-container h1 {
        color: var(--text-color); /* << USA SUA VARIÁVEL */
        font-weight: 700;
        font-size: 2.5rem;
        margin-bottom: 2rem;
    }

    /* Botões de seleção de intenção */
    .purpose-selector {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2.5rem;
    }

    .purpose-button {
        background: transparent;
        border: 2px solid var(--border-color); /* << USA SUA VARIÁVEL */
        border-radius: 10px;
        padding: 0.75rem 1.25rem;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        color: var(--text-color); /* << USA SUA VARIÁVEL */
        transition: all 0.3s ease;
    }

    .purpose-button:hover {
        border-color: var(--accent-color); /* << USA SUA VARIÁVEL */
        color: var(--accent-color); /* << USA SUA VARIÁVEL */
        transform: translateY(-3px);
    }
    
    .purpose-selector.selection-made .purpose-button:not(.active) {
        opacity: 0.6;
    }

    .purpose-button.active {
        /* Usando suas variáveis de gradiente! */
        background-image: linear-gradient(45deg, var(--lia-grad-1), var(--lia-grad-2)); 
        color: white;
        border-color: transparent;
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 5px 20px rgba(0, 123, 255, 0.3);
    }

    .purpose-button i { margin-right: 0.5rem; }

    /* Campos do formulário */
    .form-group {
        position: relative;
        margin-bottom: 2rem;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.7s ease, opacity 0.5s ease, margin-bottom 0.7s ease;
    }
    
    .form-group.visible {
        max-height: 300px;
        opacity: 1;
    }

    .form-group label {
        position: absolute;
        top: 0.85rem;
        left: 1rem;
        color: var(--text-color); /* << USA SUA VARIÁVEL */
        opacity: 0.7;
        font-weight: 500;
        pointer-events: none;
        transition: all 0.3s ease;
    }

    .form-group textarea {
        width: 100%;
        padding: 1.5rem 1rem 0.5rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color); /* << USA SUA VARIÁVEL */
        font-size: 1rem;
        color: var(--text-color); /* << USA SUA VARIÁVEL */
        background: var(--bg-color); /* << USA SUA VARIÁVEL */
        box-sizing: border-box;
        resize: vertical;
        min-height: 120px;
        transition: border-color 0.3s ease, background-color 0.3s ease;
    }
    
    .form-group textarea:focus {
        outline: none;
        border-color: var(--accent-color); /* << USA SUA VARIÁVEL */
    }
    
    .form-group textarea:focus + label,
    .form-group textarea:not(:placeholder-shown) + label {
        top: 0.4rem;
        font-size: 0.75rem;
        color: var(--accent-color); /* << USA SUA VARIÁVEL */
        opacity: 1;
    }

    /* ### NOVO ### Estilos do Contador de Caracteres */
    .char-counter-wrapper {
        text-align: right;
        margin-top: 5px;
        height: 1.2rem; /* Evita que o layout pule */
    }
    .char-counter {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-color);
        opacity: 0.7;
        transition: all 0.3s ease;
    }
    .char-counter.valid {
        color: #28a745;
        opacity: 1;
        font-weight: 600;
    }
    
    /* Avaliação por estrelas */
    #rating-group { margin-bottom: 2.5rem; }
    
    .rating-label {
        color: var(--text-color);
        opacity: 0.9;
        margin-bottom: 1rem;
        display: block;
        font-weight: 500;
    }

    .star-rating { font-size: 2.5rem; cursor: pointer; }
    .star-rating .star {
        color: var(--border-color);
        transition: all 0.2s ease-in-out;
        display: inline-block;
    }
    .star-rating .star:hover { transform: scale(1.2); }
    .star-rating .star.hover,
    .star-rating .star.selected { color: #ffc107; }

    #rating-text {
        display: block;
        margin-top: 1rem;
        height: 20px;
        color: #ffc107;
        font-weight: 600;
        transition: opacity 0.3s ease;
    }
    
    #rating { display: none; }

    /* Botão de Envio */
    .submit-btn {
        background-image: linear-gradient(45deg, var(--lia-grad-1), var(--lia-grad-2));
        background-size: 200%;
        background-position: left;
        color: white;
        border: none;
        border-radius: 10px;
        padding: 0.8rem 2rem;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        width: 100%;
        transition: all 0.4s ease;
        position: relative;
    }
    
    .submit-btn:hover {
        background-position: right;
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
    }
    
    .submit-btn .spinner { display: none; }
    .submit-btn.loading .btn-text { visibility: hidden; }
    .submit-btn.loading .spinner { display: block; }
    .submit-btn .spinner {
        display: none; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff;
        width: 20px; height: 20px; animation: spin 1s ease-in-out infinite; position: absolute;
        top: 50%; left: 50%; margin-top: -10px; margin-left: -10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

</style>

<div class="evaluation-body-wrapper">
    <div class="evaluation-container">
        <h1>Avaliação do Documento</h1>

        <div class="purpose-selector">
            <button type="button" class="purpose-button" data-purpose="feedback">
                <i class="fas fa-star"></i> Avaliação Geral
            </button>
            <button type="button" class="purpose-button" data-purpose="suggestions">
                <i class="fas fa-lightbulb"></i> Sugerir Melhoria
            </button>
            <button type="button" class="purpose-button" data-purpose="techos">
                <i class="fas fa-code"></i> Detalhe Técnico
            </button>
            <button type="button" class="purpose-button" data-purpose="changes">
                <i class="fas fa-edit"></i> Solicitar Mudança
            </button>
        </div>

        <form method="POST" action="" id="evaluationForm">
            {{ form.hidden_tag() }}

            <div id="rating-group">
                <span class="rating-label">Sua avaliação sobre a utilidade deste documento:</span>
                <div class="star-rating">
                    <span class="star" data-value="1">&#9733;</span>
                    <span class="star" data-value="2">&#9733;</span>
                    <span class="star" data-value="3">&#9733;</span>
                    <span class="star" data-value="4">&#9733;</span>
                    <span class="star" data-value="5">&#9733;</span>
                </div>
                {{ form.rating() }} 
                <span id="rating-text"></span>

                {% if form.rating.errors %}
                    <div style="color: #dc3545; font-weight: 500; margin-top: 10px; animation: shake 0.5s;">
                        {% for error in form.rating.errors %}
                            <span><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    </div>
                    <style>@keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}</style>
                {% endif %}
            </div>

            <div class="form-group" data-section="feedback">
                {{ form.feedback(placeholder=" ", **{'data-counter': 'feedback-counter'}) }}
                {{ form.feedback.label }}
                <div class="char-counter-wrapper"><span class="char-counter" id="feedback-counter">0 / 50</span></div>
            </div>
            
            <div class="form-group" data-section="suggestions">
                {{ form.suggestions(placeholder=" ", **{'data-counter': 'suggestions-counter'}) }}
                {{ form.suggestions.label }}
                <div class="char-counter-wrapper"><span class="char-counter" id="suggestions-counter">0 / 50</span></div>
            </div>

            <div class="form-group" data-section="techos">
                {{ form.techos(placeholder=" ", **{'data-counter': 'techos-counter'}) }}
                {{ form.techos.label(text="Detalhes Técnicos ou Trechos") }}
                <div class="char-counter-wrapper"><span class="char-counter" id="techos-counter">0 / 50</span></div>
            </div>
            
            <div class="form-group" data-section="changes">
                {{ form.changes(placeholder=" ", **{'data-counter': 'changes-counter'}) }}
                {{ form.changes.label }}
                <div class="char-counter-wrapper"><span class="char-counter" id="changes-counter">0 / 50</span></div>
            </div>

            <button type="submit" class="submit-btn" id="submitButton">
                <span class="btn-text">Enviar Avaliação</span>
                <div class="spinner"></div>
            </button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const purposeSelector = document.querySelector('.purpose-selector');
        const purposeButtons = document.querySelectorAll('.purpose-button');
        const formGroups = document.querySelectorAll('.form-group');
        
        purposeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const purpose = this.dataset.purpose;
                purposeSelector.classList.add('selection-made');
                purposeButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                formGroups.forEach(group => {
                    group.classList.toggle('visible', group.dataset.section === purpose);
                });
            });
        });

        const stars = document.querySelectorAll('.star-rating .star');
        const ratingInput = document.getElementById('rating');
        const ratingText = document.getElementById('rating-text');
        const ratingMeanings = ["", "Ruim", "Regular", "Bom", "Ótimo", "Excelente!"];
        
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const value = this.dataset.value;
                ratingInput.value = value;
                updateStars(value);
                ratingText.textContent = ratingMeanings[value];
            });
            star.addEventListener('mouseover', function() {
                previewStars(this.dataset.value);
                ratingText.textContent = ratingMeanings[this.dataset.value];
            });
            star.addEventListener('mouseout', function() {
                updateStars(ratingInput.value);
                ratingText.textContent = ratingMeanings[ratingInput.value] || "";
            });
        });

        function updateStars(selectedValue) {
            stars.forEach(star => {
                star.classList.toggle('selected', star.dataset.value <= selectedValue);
                star.classList.remove('hover');
            });
        }
        function previewStars(hoverValue) {
            stars.forEach(star => {
                star.classList.toggle('hover', star.dataset.value <= hoverValue);
            });
        }
        
        const form = document.getElementById('evaluationForm');
        const submitButton = document.getElementById('submitButton');
        form.addEventListener('submit', function() {
            if (!submitButton.classList.contains('loading')) {
                submitButton.classList.add('loading');
                submitButton.disabled = true;
            }
        });

        // ### NOVO ### LÓGICA DO CONTADOR DE CARACTERES
        const textareas = document.querySelectorAll('textarea[data-counter]');
        textareas.forEach(textarea => {
            const counterId = textarea.dataset.counter;
            const counterElement = document.getElementById(counterId);

            if (counterElement) {
                // Atualiza o contador no carregamento da página caso o campo já tenha texto
                updateCounter(textarea, counterElement);

                // Adiciona o listener para atualizar em tempo real
                textarea.addEventListener('input', () => {
                    updateCounter(textarea, counterElement);
                });
            }
        });

        function updateCounter(textarea, counterElement) {
            const count = textarea.value.length;
            counterElement.textContent = `${count} / 50`;
            if (count >= 50) {
                counterElement.classList.add('valid');
            } else {
                counterElement.classList.remove('valid');
            }
        }
    });
</script>
{% endblock %}