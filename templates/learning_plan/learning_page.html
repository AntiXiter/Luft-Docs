{% extends 'base.html' %}

{% block title %}Meu Plano de Aprendizado{% endblock %}

{% block content %}
<style>
  /* --- MAPEAMENTO PARA VARIÁVEIS BOOTSTRAP --- */
  /* Isso garante que os componentes do Bootstrap usem as cores do seu tema */
  body {
    --bs-body-bg: var(--bg-color);
    --bs-body-color: var(--text-color);
    --bs-border-color: var(--border-color);
    --bs-modal-bg: var(--surface-bg);
    --bs-modal-header-border-color: var(--border-color);
    --bs-modal-footer-border-color: var(--border-color);
    --bs-secondary-bg: var(--surface-bg);
    --bs-dropdown-bg: var(--surface-bg);
    --bs-dropdown-link-color: var(--text-color);
    --bs-dropdown-link-hover-bg: var(--accent-color);
    --bs-dropdown-link-hover-color: var(--bg-color);
    --bs-dropdown-border-color: var(--border-color);
    --bs-btn-close-color: var(--text-color);
  }

  /* --- ESTILOS GERAIS DA PÁGINA --- */
  body {
    margin: 0;
    overflow: hidden;
  }
  .dashboard-container {
    display: flex;
    height: 100vh;
  }

  /* --- SIDEBAR --- */
  #sidebar {
    width: 280px;
    background-color: var(--surface-bg);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    padding: 20px;
    transition: width 0.3s ease, background-color 0.3s, border-color 0.3s;
  }
  #user-profile {
    text-align: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 20px;
    margin-bottom: 20px;
  }
  #user-profile h2 {
    margin: 0;
    font-size: 1.2em;
    font-weight: 600;
  }
  #user-profile p {
    margin: 5px 0 0;
    opacity: 0.7;
    font-size: 0.9em;
  }
  #trail-navigator h3 {
    opacity: 0.7;
    text-transform: uppercase;
    font-size: 0.8em;
    letter-spacing: 1px;
    margin-bottom: 15px;
  }
  #trail-list {
    list-style: none; padding: 0; margin: 0;
    flex-grow: 1; overflow-y: auto;
  }
  #trail-list li a {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 15px; text-decoration: none;
    border-radius: 6px; margin-bottom: 5px;
    color: var(--text-color);
    transition: background-color 0.2s ease, color 0.2s ease;
  }
  #trail-list li a:hover {
    background-color: var(--bg-color);
  }
  #trail-list li a.active {
    background-color: var(--accent-color);
    color: var(--bg-color);
    font-weight: 600;
  }
  #create-trail-btn {
    color: var(--bg-color); /* Ajustado para usar cor de fundo como texto */
  }

  /* --- CONTEÚDO PRINCIPAL --- */
  #main-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #trail-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px 30px;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--surface-bg);
  }
  #trail-title {
    font-size: 1.8em;
    font-weight: 300;
    margin: 0;
  }
  #cy {
    width: 100%;
    height: 100%;
    flex-grow: 1;
  }

  /* --- SPINNER --- */
  .spinner-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex; justify-content: center; align-items: center;
    z-index: 1060; /* Acima do modal */
  }
  .spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 4px solid var(--accent-color);
    width: 50px; height: 50px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* --- COMPONENTES CUSTOMIZADOS --- */
  .module-list-container { flex: 1; display: flex; flex-direction: column; }
  .module-list-container h3 {
    margin-top: 0; font-size: 1em; opacity: 0.7;
    border-bottom: 1px solid var(--border-color); padding-bottom: 10px;
  }
  .module-list {
    list-style: none; padding: 0; margin: 0; overflow-y: auto;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color); border-radius: 5px;
    flex-grow: 1; max-height: 40vh;
  }
  .module-list li {
    padding: 10px 15px; border-bottom: 1px solid var(--border-color);
    cursor: grab; display: flex; justify-content: space-between;
    align-items: center; transition: background-color 0.2s, color 0.2s;
  }
  #available-modules-list li:hover { background-color: var(--accent-color); color: var(--bg-color); }
  #selected-modules-list li:hover { background-color: var(--bs-danger); color: #fff; }
  .sortable-ghost { opacity: 0.4; background: var(--accent-color); }

  /* Context Menu */
  #node-context-menu { position: absolute; z-index: 1050; }
  .hidden { display: none !important; }
</style>

<div class="dashboard-container">
  <div id="loader" class="spinner-overlay hidden">
    <div class="spinner"></div>
  </div>

  <aside id="sidebar">
    <div id="user-profile">
      <h2 id="user-name">Carregando...</h2>
      <p id="user-level">Nível: 0 | XP: 0</p>
    </div>
    <div id="trail-navigator">
      <h3><i class="fa-solid fa-route"></i> Suas Trilhas</h3>
      <ul id="trail-list"></ul>
    </div>
    <button id="create-trail-btn" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#create-trail-modal">
        <i class="fa-solid fa-plus-circle"></i> Criar Nova Trilha
    </button>
  </aside>

  <main id="main-content">
    <header id="trail-header">
      <h1 id="trail-title">Selecione uma trilha</h1>
      <div id="trail-actions">
        <button id="edit-trail-btn" class="btn btn-secondary hidden" data-bs-toggle="modal" data-bs-target="#edit-trail-modal"><i class="fa-solid fa-pencil-alt"></i> Editar</button>
        <button id="delete-trail-btn" class="btn btn-outline-danger hidden"><i class="fa-solid fa-trash-alt"></i> Deletar</button>
      </div>
    </header>
    <div id="cy"></div>
  </main>
</div>

<div class="modal fade" id="module-details-modal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-module-title">Detalhes do Módulo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="module-description">Descrição do módulo aqui...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" id="modal-complete-btn" class="btn btn-success"><i class="fa-solid fa-check-circle"></i> Marcar como Concluído</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="create-trail-modal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="create-trail-form">
        <div class="modal-header">
          <h5 class="modal-title">Criar Nova Trilha</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label for="new-trail-name" class="form-label">Nome da Trilha</label>
          <input type="text" class="form-control" id="new-trail-name" name="trail_name" required placeholder="Ex: Trilha de Python Avançado">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Criar Trilha</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="edit-trail-modal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form id="edit-trail-form">
        <div class="modal-header">
          <h5 class="modal-title">Editar Trilha</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="edit-trail-name" class="form-label">Nome da Trilha</label>
            <input type="text" class="form-control" id="edit-trail-name" required>
          </div>
          <div class="row">
            <div class="col-md-6 module-list-container">
              <h3>Módulos Disponíveis</h3>
              <ul id="available-modules-list" class="module-list"></ul>
            </div>
            <div class="col-md-6 module-list-container">
              <h3>Módulos na Trilha</h3>
              <ul id="selected-modules-list" class="module-list"></ul>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="node-context-menu" class="dropdown-menu">
    <button id="edit-module-from-menu" class="dropdown-item"><i class="fa-solid fa-pencil me-2"></i>Editar Módulo</button>
    <button id="remove-module-from-menu" class="dropdown-item text-danger"><i class="fa-solid fa-trash-can me-2"></i>Remover da Trilha</button>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<script>
document.addEventListener('DOMContentLoaded', () => {

  // ===================================================================
  // ESTADO E ELEMENTOS DO DOM
  // ===================================================================
  let cy;
  let currentTrailId = null;
  let allModules = [];

  const dom = {
    loader: document.getElementById('loader'),
    userName: document.getElementById('user-name'),
    userLevel: document.getElementById('user-level'),
    trailList: document.getElementById('trail-list'),
    trailTitle: document.getElementById('trail-title'),
    cyContainer: document.getElementById('cy'),
    editBtn: document.getElementById('edit-trail-btn'),
    deleteBtn: document.getElementById('delete-trail-btn'),
    createTrailBtn: document.getElementById('create-trail-btn'),
    createTrailModal: document.getElementById('create-trail-modal'),
    createTrailForm: document.getElementById('create-trail-form'),
    moduleDetailsModal: document.getElementById('module-details-modal'),
    modalModuleTitle: document.getElementById('modal-module-title'),
    moduleDescription: document.getElementById('module-description'),
    modalCompleteBtn: document.getElementById('modal-complete-btn'),
    editTrailModal: document.getElementById('edit-trail-modal'),
    editTrailForm: document.getElementById('edit-trail-form'),
    editTrailNameInput: document.getElementById('edit-trail-name'),
    availableModulesList: document.getElementById('available-modules-list'),
    selectedModulesList: document.getElementById('selected-modules-list')
  };

  // ===================================================================
  // FUNÇÕES DE API (sem alterações)
  // ===================================================================
  const api = {
    async fetch(url, options = {}) {
      dom.loader.classList.remove('hidden');
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({
            message: `Erro HTTP ${response.status}`
          }));
          throw new Error(errorData.message || `Erro desconhecido`);
        }
        return response.json();
      } catch (error) {
        console.error('Erro na API:', error);
        alert(`Erro na comunicação: ${error.message}`);
        return null;
      } finally {
        dom.loader.classList.add('hidden');
      }
    },
    getNavigatorData: () => api.fetch('/api/navigator-data'),
    getTrailData: (trailId) => api.fetch(`/api/trail-data/${trailId}`),
    getAllModules: () => api.fetch('/api/all-modules'),
    createTrail: (name) => api.fetch('/api/trails', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        trail_name: name
      })
    }),
    deleteTrail: (trailId) => api.fetch(`/api/trails/${trailId}`, {
      method: 'DELETE'
    }),
    updateTrail: (trailId, name, moduleIds) => api.fetch(`/api/trails/${trailId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        trail_name: name,
        modules: moduleIds
      })
    }),
    completeModule: (moduleId) => api.fetch(`/api/modules/${moduleId}/complete`, {
      method: 'POST'
    })
  };

  // ===================================================================
  // FUNÇÕES DE ESTILO E RENDERIZAÇÃO
  // ===================================================================
  
  /**
    * Retorna a folha de estilos para o gráfico Cytoscape.
    * Centraliza a configuração visual do grafo.
    */
  function getCytoscapeStyle() {
    return [
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'font-size': '12px',
          'color': 'var(--text-color)',
          'text-halign': 'center',
          'text-valign': 'center',
          'text-wrap': 'wrap',
          'text-max-width': '80%', // Garante que o texto não saia do nó
          'transition-property': 'background-color, border-color, color',
          'transition-duration': '0.3s'
        }
      },
      {
        selector: 'node[type="trail_center"]',
        style: {
          'background-color': 'var(--accent-color)',
          'color': 'var(--bg-color)', // Cor de texto que contrasta com o accent-color
          'width': 110,
          'height': 110,
          'font-size': '16px',
          'font-weight': 'bold',
          'border-width': 0, // Sem borda para o nó central
        }
      },
      {
        selector: 'node[type!="trail_center"]',
        style: {
          'background-color': 'var(--surface-bg)',
          'border-width': 3,
          'border-color': 'var(--border-color)',
          'width': 80,
          'height': 80,
        }
      },
      {
        selector: '.completed',
        style: {
          'background-color': '#28a745', // Verde sucesso
          'border-color': '#208538', // Borda um pouco mais escura
          'color': '#ffffff', // Texto branco para alto contraste
          'label': '✅ ' + 'data(label)', // Adiciona um checkmark ao texto
          'font-weight': 'bold'
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 2,
          'line-color': 'var(--border-color)',
          'target-arrow-shape': 'none',
          'curve-style': 'bezier', // Linhas mais suaves
           'transition-property': 'line-color',
          'transition-duration': '0.3s'
        }
      }
    ];
  }

  function renderNavigator(data) {
    dom.userName.textContent = data.user_name || 'Usuário';
    dom.userLevel.textContent = `Nível: ${data.user_progress.level} | XP: ${data.user_progress.xp}`;

    dom.trailList.innerHTML = '';
    data.trails.forEach(trail => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '#';
      a.dataset.trailId = trail.id;
      const iconClass = trail.id === 'recommended' ? 'fa-star' : 'fa-map-signs';
      a.innerHTML = `<i class="fa-solid ${iconClass}"></i><span>${trail.name}</span>`;
      a.addEventListener('click', (e) => {
        e.preventDefault();
        loadAndRenderTrail(trail.id);
      });
      li.appendChild(a);
      dom.trailList.appendChild(li);
    });
  }

  function renderTrailGraph(data) {
    dom.trailTitle.textContent = data.trail_name;
    updateTrailActionButtons();

    if (cy) {
      cy.destroy();
    }
    cy = cytoscape({
      container: dom.cyContainer,
      elements: data.cytoscape_elements,
      style: getCytoscapeStyle(), // Usa a função para obter os estilos
      
      // ================================================================
      // ALTERAÇÃO PRINCIPAL: Substituição do layout para simulação física
      // ================================================================
      layout: {
        name: 'cose',
        // --- Parâmetros da Simulação Física ---
        // Ideal para fazer os nós "flutuarem" e se repelirem.
        
        animate: 'end',           // Anima a transição para a posição final.
        animationDuration: 1000,  // Duração da animação em ms.
        fit: true,                // Ajusta o grafo à área de visualização.
        padding: 50,              // Espaçamento em torno do grafo.
        
        // --- Forças ---
        nodeRepulsion: 400000,    // Força de repulsão entre os nós (aumente para mais "espaço").
        idealEdgeLength: 150,     // Comprimento ideal das arestas (como molas).
        edgeElasticity: 150,      // Elasticidade das arestas (a "dureza" da mola).
        gravity: 80,              // Atrai os nós para o centro, evitando que se espalhem demais.
        
        // --- Outras Configurações ---
        nodeOverlap: 20,          // Penalidade extra para evitar sobreposição de nós.
        randomize: true,          // Começa com posições aleatórias para um melhor resultado.
        componentSpacing: 100     // Espaço entre componentes desconectados do grafo.
      }
    });

    // --- Eventos do Gráfico ---
    cy.on('tap', 'node[type!="trail_center"]', (evt) => {
      const node = evt.target;
      const moduleId = node.id().replace('module_', '');
      openModuleDetailsModal(node.data('label'), node.data('description'), moduleId);
    });

    cy.on('cxttap', 'node[type!="trail_center"]', (evt) => {
      evt.preventDefault();
      const node = evt.target;
      const moduleId = parseInt(node.id().replace('module_', ''));

      if (currentTrailId === 'recommended') return;

      const tippyInstance = tippy(evt.target.popperRef(), {
        content: `<div>
            <button class="menu-btn edit-module-btn"><i class="fa-solid fa-pencil"></i> Editar Módulo</button>
            <button class="menu-btn remove-module-btn"><i class="fa-solid fa-trash-can"></i> Remover da Trilha</button>
          </div>`,
        allowHTML: true,
        trigger: 'manual',
        interactive: true,
        appendTo: document.body,
        onHidden(instance) {
          instance.destroy();
        }
      });

      tippyInstance.show();
      const popper = tippyInstance.popper;

      popper.querySelector('.edit-module-btn').addEventListener('click', () => {
        alert(`Funcionalidade "Editar Módulo ${moduleId}" a ser implementada!`);
        tippyInstance.hide();
      });

      popper.querySelector('.remove-module-btn').addEventListener('click', async () => {
        tippyInstance.hide();
        if (!confirm(`Remover o módulo "${node.data('label')}" desta trilha?`)) return;

        const trailData = await api.getTrailData(currentTrailId);
        if (!trailData) return;

        const newModuleIds = trailData.module_ids.filter(id => id !== moduleId);
        const result = await api.updateTrail(currentTrailId, trailData.trail_name, newModuleIds);

        if (result) {
          alert(result.message);
          loadAndRenderTrail(currentTrailId);
        }
      });
    });
  }

  // ===================================================================
  // LÓGICA PRINCIPAL E DE MODAIS (sem alterações)
  // ===================================================================
  async function loadAndRenderTrail(trailId) {
    currentTrailId = trailId;
    const trailData = await api.getTrailData(trailId);
    if (trailData) {
      renderTrailGraph(trailData);
      document.querySelectorAll('#trail-list a').forEach(a => a.classList.toggle('active', a.dataset.trailId == trailId));
    }
  }

  function updateTrailActionButtons() {
    const isCustomTrail = currentTrailId !== 'recommended';
    dom.editBtn.classList.toggle('hidden', !isCustomTrail);
    dom.deleteBtn.classList.toggle('hidden', !isCustomTrail);
  }

  function openModal(modal) {
    var bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
  }

  function closeModal(modal) {
      var bootstrapModal = bootstrap.Modal.getInstance(modal);
      if (bootstrapModal) {
          bootstrapModal.hide();
      }
  }

  function setupModalEventListeners() {
    dom.createTrailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const trailName = new FormData(e.target).get('trail_name');
      const result = await api.createTrail(trailName);
      if (result) {
        alert(result.message);
        closeModal(dom.createTrailModal);
        const navData = await api.getNavigatorData();
        if (navData) renderNavigator(navData);
        loadAndRenderTrail(result.new_trail.id);
      }
    });

    dom.editBtn.addEventListener('click', async () => {
      const [trailData, allModulesData] = await Promise.all([
        api.getTrailData(currentTrailId),
        api.getAllModules()
      ]);
      if (!trailData || !allModulesData) return;

      allModules = allModulesData;
      dom.editTrailNameInput.value = trailData.trail_name;
      const selectedModuleIds = new Set(trailData.module_ids);

      dom.selectedModulesList.innerHTML = '';
      trailData.module_ids.forEach(id => {
        const module = allModules.find(m => m.id === id);
        if (module) addModuleToList(dom.selectedModulesList, module);
      });

      dom.availableModulesList.innerHTML = '';
      allModules.forEach(module => {
        if (!selectedModuleIds.has(module.id)) addModuleToList(dom.availableModulesList, module);
      });
      
      // Inicializa SortableJS se ainda não foi inicializado
      if(!dom.selectedModulesList.sortable) {
        new Sortable(dom.selectedModulesList, { group: 'shared', animation: 150, ghostClass: 'sortable-ghost' });
      }
       if(!dom.availableModulesList.sortable) {
        new Sortable(dom.availableModulesList, { group: 'shared', animation: 150 });
      }
    });

    dom.editTrailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const newName = dom.editTrailNameInput.value;
      const moduleIds = Array.from(dom.selectedModulesList.children).map(li => parseInt(li.dataset.moduleId));
      const result = await api.updateTrail(currentTrailId, newName, moduleIds);
      if (result) {
        alert(result.message);
        closeModal(dom.editTrailModal);
        const navData = await api.getNavigatorData();
        if (navData) renderNavigator(navData);
        loadAndRenderTrail(currentTrailId);
      }
    });

    dom.deleteBtn.addEventListener('click', async () => {
      if (!confirm(`Tem certeza que deseja deletar a trilha "${dom.trailTitle.textContent}"?`)) return;

      const result = await api.deleteTrail(currentTrailId);
      if (result) {
        alert(result.message);
        const navData = await api.getNavigatorData();
        if (navData) renderNavigator(navData);
        loadAndRenderTrail('recommended');
      }
    });
  }
  
  function openModuleDetailsModal(title, description, moduleId) {
    dom.modalModuleTitle.textContent = title;
    dom.moduleDescription.textContent = description || "Nenhuma descrição disponível.";
    dom.modalCompleteBtn.onclick = async () => {
      const result = await api.completeModule(moduleId);
      if (result) {
        alert(result.message);
        closeModal(dom.moduleDetailsModal);
        // Recarrega os dados para atualizar o progresso visualmente
        const navData = await api.getNavigatorData();
        if (navData) renderNavigator(navData);
        loadAndRenderTrail(currentTrailId);
      }
    };
    openModal(dom.moduleDetailsModal);
  }


  function addModuleToList(listElement, module) {
    const li = document.createElement('li');
    li.dataset.moduleId = module.id;
    li.textContent = module.module_name;
    listElement.appendChild(li);
  }
  
  // ===================================================================
  // INICIALIZAÇÃO
  // ===================================================================
  async function init() {
    setupModalEventListeners(); // Agora só configura os listeners de formulário
    const navData = await api.getNavigatorData();
    if (navData) {
      renderNavigator(navData);
      if (navData.trails.length > 0) {
        // Carrega a primeira trilha da lista por padrão
        loadAndRenderTrail(navData.trails[0].id);
      }
    }
  }

  init();
});
</script>
{% endblock %}