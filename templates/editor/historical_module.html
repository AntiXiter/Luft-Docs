{% extends "base.html" %}
{% block title %}Histórico do Módulo: {{ mid }}{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
  .version-card {
    border: 1px solid #e3e6f0;
    border-radius: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    transition: box-shadow 0.2s;
    background: #fff;
    cursor: pointer;
  }
  .version-card.active {
    border: 2px solid #0d6efd;
    box-shadow: 0 4px 16px rgba(13,110,253,0.08);
    cursor: default;
  }
  .version-header {
    background: linear-gradient(90deg, #f8fafc 60%, #e9f2ff 100%);
    border-bottom: 1px solid #e3e6f0;
    border-radius: 1rem 1rem 0 0;
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .version-header .bi {
    font-size: 1.7rem;
    color: #0d6efd;
  }
  .version-body {
    padding: 1rem 1.5rem;
    background: #fcfcfd;
  }
  .vigente-badge {
    background: #0d6efd;
    color: #fff;
    border-radius: 0.5rem;
    padding: 0.2rem 0.7rem;
    font-size: 0.95rem;
    margin-left: 0.5rem;
  }
  .pre-content {
    background: #f8f9fa;
    border: 1px solid #e3e6f0;
    border-radius: 0.5rem;
    padding: 1rem;
    max-height: 220px;
    overflow: auto;
    font-size: 0.98rem;
  }
  .tab-modern {
    border-bottom: 2px solid #e3e6f0;
    margin-bottom: 2rem;
  }
  .tab-modern .nav-link.active {
    border-bottom: 3px solid #0d6efd;
    color: #0d6efd !important;
    background: #f8fafc;
  }
  .version-card .text-end {
    pointer-events: none;
  }
  .version-card.active {
    pointer-events: none;
    opacity: 0.85;
  }
</style>

<!-- Modal de comparação -->
<div class="modal fade" id="compareModal" tabindex="-1" aria-labelledby="compareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="compareModalLabel"><i class="bi bi-files"></i> Comparar versões</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Versão Selecionada</h6>
            <pre class="pre-content" id="modal-old-content"></pre>
          </div>
          <div class="col-md-6">
            <h6>Versão Atual</h6>
            <pre class="pre-content" id="modal-current-content"></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <form method="post" id="restoreForm">
          <input type="hidden" name="versao" id="modal-version-filename">
          <input type="hidden" name="tipo" id="modal-version-tipo">
          <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-clockwise"></i> Definir como atual</button>
        </form>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<div class="container py-4">
  <h2 class="mb-4"><i class="bi bi-clock-history"></i> Histórico de versões <span class="text-primary">{{ mid }}</span></h2>

  <ul class="nav nav-tabs tab-modern" id="versionTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="doc-tab" data-bs-toggle="tab" data-bs-target="#doc" type="button" role="tab" aria-controls="doc" aria-selected="true">
        <i class="bi bi-file-earmark-text"></i> Documentação
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tech-tab" data-bs-toggle="tab" data-bs-target="#tech" type="button" role="tab" aria-controls="tech" aria-selected="false">
        <i class="bi bi-cpu"></i> Técnica
      </button>
    </li>
  </ul>
  <div class="tab-content" id="versionTabsContent">
    <!-- Documentação -->
    <div class="tab-pane fade show active" id="doc" role="tabpanel" aria-labelledby="doc-tab">
      <div class="version-card active mb-4">
        <div class="version-header">
          <i class="bi bi-star-fill"></i>
          <div>
            <strong>Versão vigente (Documentação)</strong>
            <span class="vigente-badge">Atual</span>
          </div>
        </div>
        <div class="version-body">
          <pre class="pre-content">{{ vigente }}</pre>
        </div>
      </div>
      <h5 class="mb-3"><i class="bi bi-clock"></i> Histórico de versões anteriores</h5>
      <div class="row">
        {% for h in historicos %}
        <div class="col-md-6">
          <div class="version-card mb-3 version-select"
               data-content="{{ h.content|e }}"
               data-filename="{{ h.filename }}"
               data-tipo="doc">
            <div class="version-header">
              <i class="bi bi-file-earmark-diff"></i>
              <div>
                <strong>{{ h.filename }}</strong>
                <span class="text-muted" style="font-size:0.95em;">({{ h.filename[:19]|replace('T',' ') }})</span>
              </div>
            </div>
            <div class="version-body">
              <pre class="pre-content" style="max-height:60px;overflow:hidden;">{{ h.content }}</pre>
              <div class="text-end text-primary small mt-1">Clique para comparar</div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <!-- Técnica -->
    <div class="tab-pane fade" id="tech" role="tabpanel" aria-labelledby="tech-tab">
      <div class="version-card active mb-4">
        <div class="version-header">
          <i class="bi bi-star-fill"></i>
          <div>
            <strong>Versão vigente (Técnica)</strong>
            <span class="vigente-badge">Atual</span>
          </div>
        </div>
        <div class="version-body">
          <pre class="pre-content">{{ vigente_tech }}</pre>
        </div>
      </div>
      <h5 class="mb-3"><i class="bi bi-clock"></i> Histórico de versões técnicas</h5>
      <div class="row">
        {% for h in historicos_tech %}
        <div class="col-md-6">
          <div class="version-card mb-3 version-select"
               data-content="{{ h.content|e }}"
               data-filename="{{ h.filename }}"
               data-tipo="tech">
            <div class="version-header">
              <i class="bi bi-file-earmark-diff"></i>
              <div>
                <strong>{{ h.filename }}</strong>
                <span class="text-muted" style="font-size:0.95em;">({{ h.filename[:19]|replace('T',' ') }})</span>
              </div>
            </div>
            <div class="version-body">
              <pre class="pre-content" style="max-height:60px;overflow:hidden;">{{ h.content }}</pre>
              <div class="text-end text-primary small mt-1">Clique para comparar</div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="mt-4">
    <a href="{{ url_for('editor.editor_index', token=token) }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Voltar
    </a>
  </div>
</div>
<script>
  // Abre a tab correta se houver hash na URL
  if (window.location.hash) {
    var tab = document.querySelector('button[data-bs-target="' + window.location.hash + '"]');
    if(tab) tab.click();
  }

  // Modal de comparação
  document.querySelectorAll('.version-select').forEach(function(card) {
    card.addEventListener('click', function() {
      var content = card.getAttribute('data-content');
      var filename = card.getAttribute('data-filename');
      var tipo = card.getAttribute('data-tipo');
      var currentContent = '';
      if (tipo === 'doc') {
        currentContent = {{ vigente|tojson|safe }};
      } else {
        currentContent = {{ vigente_tech|tojson|safe }};
      }
      document.getElementById('modal-old-content').textContent = content;
      document.getElementById('modal-current-content').textContent = currentContent;
      document.getElementById('modal-version-filename').value = filename;
      document.getElementById('modal-version-tipo').value = tipo;
      var modal = new bootstrap.Modal(document.getElementById('compareModal'));
      modal.show();
    });
  });
</script>
{% endblock %}