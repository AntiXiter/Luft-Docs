{% extends "base.html" %}
{% block title %}LuftDocs - Início{% endblock %}

{% block content %}
<style>
    /* Fundo animado com gradiente */
    body {
        background: linear-gradient(120deg, #e0e7ff 0%, #f9f9fb 100%);
        background-size: 200% 200%;
        animation: bgMove 12s ease-in-out infinite;
        perspective: 1500px;
    }
    @keyframes bgMove {
        0%   { background-position: 0% 50%; }
        50%  { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    body.theme-dark {
        background: linear-gradient(120deg, #23263b 0%, #1e1e2f 100%);
        background-size: 200% 200%;
        animation: bgMove 12s ease-in-out infinite;
    }

    /* Modern Card Animations */
    .modern-card {
        min-height: 370px;
        max-height: 370px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border-radius: 1.25rem;
        transition: box-shadow 0.3s cubic-bezier(.4,2,.3,1), border-color 0.2s, transform 0.25s;
        border: 1.5px solid #e3e6ed;
        background: #fff;
        box-shadow: 0 2px 8px rgba(80, 120, 200, 0.08);
        opacity: 0;
        transform: translateY(40px) scale(0.97);
        animation: cardFadeIn 0.7s forwards;
        animation-delay: calc(var(--card-index) * 0.08s);
        position: relative;
        overflow: hidden;
        z-index: 1;
    }
    @keyframes cardFadeIn {
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    .modern-card::after {
        content: "";
        position: absolute;
        top: -80px; left: -80px;
        width: 160px; height: 160px;
        background: radial-gradient(circle, #b6d0ff55 40%, transparent 80%);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s;
        z-index: 2;
    }
    .modern-card:hover::after {
        opacity: 0.7;
        animation: shine 1.2s linear;
    }
    @keyframes shine {
        0%   { transform: scale(0.8) rotate(0deg); }
        100% { transform: scale(1.2) rotate(30deg); }
    }
    body.theme-dark .modern-card {
        background: #23263b;
        box-shadow: 0 2px 16px rgba(13,110,253,0.10), 0 2px 12px rgba(0,0,0,0.28) !important;
        border-color: #23263b !important;
    }
    body.theme-dark .modern-card:hover {
        box-shadow: 0 12px 36px rgba(13,110,253,0.18), 0 2px 8px rgba(0,0,0,0.18) !important;
        border-color: #0d6efd !important;
    }
    .modern-card:hover {
        box-shadow: 0 16px 48px rgba(80, 120, 200, 0.22), 0 2px 8px rgba(80, 120, 200, 0.04);
        border-color: #0d6efd;
        transform: translateY(-8px) scale(1.04) rotate(-1deg);
    }
    .modern-card .display-4 {
        transition: transform 0.3s cubic-bezier(.4,2,.3,1), color 0.2s;
        filter: drop-shadow(0 2px 8px #0d6efd22);
        animation: pulseIcon 2.2s infinite;
    }
    .modern-card:hover .display-4 {
        transform: scale(1.18) rotate(6deg);
        color: #0d6efd;
        filter: drop-shadow(0 4px 16px #0d6efd44);
        animation: pulseIconHover 0.8s;
    }
    @keyframes pulseIcon {
        0%,100% { transform: scale(1); }
        50%      { transform: scale(1.08); }
    }
    @keyframes pulseIconHover {
        0%   { transform: scale(1.18) rotate(6deg); }
        50%  { transform: scale(1.28) rotate(8deg); }
        100% { transform: scale(1.18) rotate(6deg); }
    }

    /* Ripple nos botões */
    .modern-btn {
        min-width: 140px;
        margin: 0.25rem;
        font-weight: 500;
        border-radius: 2rem;
        transition: background 0.15s, color 0.15s, box-shadow 0.2s;
        box-shadow: 0 1px 4px rgba(13,110,253,0.04);
        position: relative;
        overflow: hidden;
        z-index: 1;
    }
    .modern-btn:active::after {
        content: "";
        position: absolute;
        left: 50%; top: 50%;
        width: 0; height: 0;
        background: rgba(13,110,253,0.18);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: ripple 0.5s linear;
        z-index: 2;
    }
    @keyframes ripple {
        to {
            width: 220px;
            height: 220px;
            opacity: 0;
        }
    }

    /* --- Ícones decorativos flutuantes --- */
    .bg-icons {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        pointer-events: none;
        height: 2100px;
        overflow: hidden;
        z-index: 0;
    }
    .bg-icons .bg-icon {
        position: absolute;
        color: rgba(13,110,253,0.13);
        /* As propriedades de animação são definidas pelo JS */
    }
    body.theme-dark .bg-icons .bg-icon {
        color: rgba(255,255,255,0.13);
    }
    @keyframes iconRise {
        0%   { transform: translateY(0) rotate(0deg); opacity: 1; }
        50%  { transform: translateY(-50vh) rotate(180deg); opacity: 0.7; }
        100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }

    /* Restante dos estilos originais */
    .modern-card .card-body {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1;
        position: relative;
    }
    .modern-card .card-title {
        color: var(--primary-accent-color, #0d6efd);
        font-size: 1.15rem;
        margin-bottom: 1.2rem;
        letter-spacing: 0.01em;
        font-weight: 600;
        transition: color 0.2s;
    }
    .modern-card:hover .card-title {
        color: #0d6efd;
        text-shadow: 0 2px 12px #b6d0ff55;
    }
    .modern-card .card-text {
        color: #6c757d;
        font-size: 0.98rem;
        text-align: center;
        margin-bottom: 0.5rem;
        transition: color 0.2s;
    }
    .modern-card:hover .card-text {
        color: #495057;
    }
    .modern-btn i {
        margin-right: 0.4em;
        transition: transform 0.2s;
    }
    .modern-btn:hover i {
        transform: translateY(-2px) scale(1.1) rotate(-8deg);
    }
    .modern-btn:active {
        box-shadow: 0 0 0 2px #0d6efd33;
    }
    .add-new-card {
        background: transparent !important;
        border: 2px dashed var(--border-color, #ced4da) !important;
        color: #6c757d !important;
        box-shadow: none !important;
        transition: border-color 0.2s, color 0.2s, background 0.2s;
    }
    .add-new-card:hover {
        border-color: #0d6efd !important;
        color: #0d6efd !important;
        background: #f8f9fa !important;
    }

    body.page-transition-out .container {
        transform: translateY(50px) scale(0.95);
        opacity: 0;
        transition: transform 0.5s cubic-bezier(0.55, 0.085, 0.68, 0.53), opacity 0.4s ease-out;
    }

    body.theme-dark .add-new-card {
        background: transparent !important;
        border-color: #3b405f !important;
        color: #b6d0ff !important;
    }
    body.theme-dark .add-new-card:hover {
        border-color: #0d6efd !important;
        color: #0d6efd !important;
        background: #23263b !important;
    }
    @media (max-width: 575px) {
        .modern-card {
            min-height: 320px;
            max-height: 320px;
        }
    }
</style>

<div class="bg-icons"></div>

<div class="container my-5 position-relative" style="z-index:2;">
    <div class="mb-4 text-end d-flex justify-content-end gap-2">
        <a href="{{ url_for('index.mapa_conhecimento', token=request.args.get('token')) }}" class="btn btn-primary modern-btn page-transition-btn">
            <i class="bi bi-diagram-3"></i> Ver Mapa
        </a>
        {% if can_access_editor %}
            <a href="{{ url_for('editor.editor_index', token=request.args.get('token')) }}" class="btn btn-outline-dark modern-btn page-transition-btn">
                <i class="bi bi-pencil-square"></i> Acessar editor
            </a>
        {% endif %}
        {% if can_access_permissions_menu %}
            <a href="{{ url_for('permissions.manage_permissions', token=request.args.get('token')) }}" class="btn btn-outline-dark modern-btn page-transition-btn">
                <i class="bi bi-shield-lock"></i> Gerenciar permissões
            </a>
        {% endif %}
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="Title mb-0">Módulos do LuftDocs</h1>
        <div class="position-relative" style="min-width: 250px;">
            <input type="text" id="filterInput" class="form-control ps-4" placeholder="Filtrar módulos...">
            <i class="bi bi-search position-absolute top-50 translate-middle-y" style="left: 10px; color: #6c757d;"></i>
        </div>
    </div>

    <div class="row g-4" id="modules-row">
        </div>
    
    <div id="no-results-message" class="col-12 text-center py-5" style="display: none;">
        <i class="bi bi-emoji-frown fs-1 text-muted"></i>
        <h4 class="mt-3">Nenhum módulo encontrado</h4>
        <p class="text-muted">Tente ajustar os termos da sua busca.</p>
    </div>

    <div id="pagination-container" class="mt-5 d-flex justify-content-center">
        </div>

</div>

<script>
// =========================================================================
// LÓGICA DE BUSCA, PAGINAÇÃO E RENDERIZAÇÃO (NOVO)
// =========================================================================
document.addEventListener('DOMContentLoaded', () => {
    const filterInput = document.getElementById('filterInput');
    const modulesRow = document.getElementById('modules-row');
    const noResultsMessage = document.getElementById('no-results-message');
    const paginationContainer = document.getElementById('pagination-container');
    
    const urlParams = new URLSearchParams(window.location.search);
    const TOKEN = urlParams.get('token');
    
    let searchTimeout;

    // Função principal que busca e renderiza os dados da API
    async function fetchAndRenderCards(searchTerm = '', page = 1) {
        modulesRow.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';
        noResultsMessage.style.display = 'none';
        paginationContainer.innerHTML = '';

        try {
            const response = await fetch(`/api/modules?search=${encodeURIComponent(searchTerm)}&page=${page}&token=${TOKEN}`);
            if (!response.ok) throw new Error(`Erro na rede: ${response.statusText}`);
            
            const data = await response.json();
            
            modulesRow.innerHTML = '';
            
            if (data.cards && data.cards.length > 0) {
                renderCards(data.cards, data.token);
                renderPagination(data.current_page, data.total_pages);
            } else {
                noResultsMessage.style.display = 'block';
            }
        } catch (error) {
            console.error("Falha ao buscar módulos:", error);
            modulesRow.innerHTML = '<div class="col-12 text-center py-5 text-danger"><strong>Oops!</strong> Falha ao carregar os módulos. Verifique sua conexão e tente novamente.</div>';
        }
    }

    // Função para renderizar os cards no DOM
    function renderCards(cards, token) {
        cards.forEach((m, index) => {
            let cardHtml = '';
            if (m.type === 'create_card') {
                cardHtml = `
                    <div class="col-12 col-sm-6 col-md-4 d-flex module-card-wrapper">
                        <a href="/editor/novo?token=${token}" class="card modern-card add-new-card w-100 shadow-none border-0 text-decoration-none" style="--card-index: ${index}">
                            <div class="card-body d-flex flex-column align-items-center justify-content-center" style="flex:1;">
                                <i class="bi bi-plus-circle-dotted display-4 mb-3"></i>
                                <h5 class="card-title">Criar Novo Módulo</h5>
                            </div>
                        </a>
                    </div>
                `;
            } else {
                cardHtml = `
                    <div class="col-12 col-sm-6 col-md-4 d-flex module-card-wrapper">
                        <div class="card modern-card w-100 shadow-sm border-0" style="--card-index: ${index}">
                            <div class="card-body">
                                <i class="bi ${m.icone || 'bi-box'} display-4 text-primary mb-3"></i>
                                <h5 class="card-title">${m.nome}</h5>
                                <p class="card-text">${m.descricao}</p>
                            </div>
                            <div class="pb-3 text-center" style="margin-bottom: 1rem;">
                                ${m.has_content ? `
                                <a class="btn btn-outline-primary modern-btn me-2 page-transition-btn" href="/modulo/?modulo=${m.id}&token=${token}">
                                    <i class="bi bi-search"></i> Ver módulo
                                </a>` : ''}
                                ${m.show_tecnico_button ? `
                                <a class="btn btn-outline-secondary modern-btn ms-2 page-transition-btn" href="/modulo/?modulo_tecnico=${m.id}&token=${token}">
                                    <i class="bi bi-tools"></i> Módulo Técnico
                                </a>` : ''}
                            </div>
                            <div style="position: absolute; bottom: 10px; right: 15px; font-size: 0.60rem; color: #6c757d;">
                                <i class="fas fa-user"></i> V${m.version_info?.current_version || '1.0'}
                            </div>
                        </div>
                    </div>
                `;
            }
            modulesRow.insertAdjacentHTML('beforeend', cardHtml);
        });
        // Re-aplica o listener de transição para os novos botões criados
        setupPageTransitionListeners();
    }

    // Função para renderizar a paginação no DOM
    function renderPagination(currentPage, totalPages) {
        if (totalPages <= 1) {
            paginationContainer.innerHTML = '';
            return;
        }

        let paginationHtml = '<nav aria-label="Navegação dos módulos"><ul class="pagination">';
        paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage - 1}">Anterior</a></li>`;
        
        for (let i = 1; i <= totalPages; i++) {
            paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }

        paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage + 1}">Próxima</a></li>`;
        paginationHtml += '</ul></nav>';
        
        paginationContainer.innerHTML = paginationHtml;
    }

    // Listener para o filtro com debounce
    filterInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            fetchAndRenderCards(e.target.value.trim(), 1);
        }, 300);
    });
    
    // Listener para paginação com delegação de eventos
    paginationContainer.addEventListener('click', (e) => {
        e.preventDefault();
        const target = e.target;
        if (target.tagName === 'A' && target.dataset.page) {
            const page = parseInt(target.dataset.page, 10);
            const searchTerm = filterInput.value.trim();
            if (!isNaN(page) && !target.closest('.page-item.disabled')) {
                fetchAndRenderCards(searchTerm, page);
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Rola para o topo
            }
        }
    });

    // Carga inicial dos dados
    fetchAndRenderCards();

    // =========================================================================
    // LÓGICA DE TRANSIÇÃO DE PÁGINA (ATUALIZADO)
    // =========================================================================
    function setupPageTransitionListeners() {
        // Seleciona todos os links que devem ter a transição
        document.querySelectorAll('.page-transition-btn').forEach(btn => {
            // Remove listener antigo para evitar duplicação
            btn.removeEventListener('click', handleTransitionClick); 
            // Adiciona o novo listener
            btn.addEventListener('click', handleTransitionClick);
        });
    }

    function handleTransitionClick(event) {
        event.preventDefault();
        const destinationUrl = event.currentTarget.href;
        document.body.classList.add('page-transition-out');
        setTimeout(() => {
            window.location.href = destinationUrl;
        }, 500); // Duração da animação
    }

    // Configuração inicial dos listeners de transição
    setupPageTransitionListeners();

});

// =========================================================================
// LÓGICA DA ANIMAÇÃO DE FUNDO (ORIGINAL)
// =========================================================================
const bgContainer = document.querySelector('.bg-icons');
let bgAnimationFrameId = null;

function getAnimationParameters() {
    const quantity = parseInt(localStorage.getItem('ld_bg_quantity') || '50', 10);
    const speedFactor = parseFloat(localStorage.getItem('ld_bg_speed') || '1.0');
    const randomnessFactor = 1 + (speedFactor - 1) * 0.5;
    return { quantity, speedFactor, randomnessFactor };
}

function iniciarAnimacaoComColisao() {
    const { quantity, speedFactor, randomnessFactor } = getAnimationParameters();
    const iconsData = [];
    const screenWidth = bgContainer.offsetWidth;
    const screenHeight = bgContainer.offsetHeight;

    fetch('{{ url_for("static", filename="data/icons.json") }}')
        .then(res => res.json())
        .then(availableIcons => {
            for (let i = 0; i < quantity; i++) {
                const el = document.createElement('i');
                const size = (Math.random() * 32 * randomnessFactor + 16);

                el.className = `bi ${availableIcons[Math.floor(Math.random() * availableIcons.length)]} bg-icon`;
                el.style.fontSize = `${size}px`;
                el.style.position = 'absolute'; // Garantir posicionamento absoluto
                bgContainer.appendChild(el);

                iconsData.push({
                    element: el,
                    x: Math.random() * (screenWidth - size),
                    y: Math.random() * (screenHeight - size),
                    dx: (Math.random() - 0.5) * 1.5 * speedFactor,
                    dy: (Math.random() - 0.5) * 1.5 * speedFactor,
                    size: size
                });
            }
            animate();
        })
        .catch(console.error);

    function animate() {
        iconsData.forEach(icon => {
            icon.x += icon.dx;
            icon.y += icon.dy;
            if (icon.x <= 0 || icon.x + icon.size >= screenWidth) { icon.dx *= -1; }
            if (icon.y <= 0 || icon.y + icon.size >= screenHeight) { icon.dy *= -1; }
            icon.element.style.transform = `translate(${icon.x}px, ${icon.y}px)`;
        });
        bgAnimationFrameId = requestAnimationFrame(animate);
    }
}

function iniciarAnimacaoOriginal() {
    const { quantity, speedFactor, randomnessFactor } = getAnimationParameters();

    fetch('{{ url_for("static", filename="data/icons.json") }}')
        .then(res => res.json())
        .then(icons => {
            for (let i = 0; i < quantity; i++) {
                const cls = icons[Math.floor(Math.random() * icons.length)];
                const el = document.createElement('i');
                el.className = `bi ${cls} bg-icon`;

                el.style.fontSize = `${(Math.random() * 2 * randomnessFactor + 1).toFixed(2)}rem`;
                el.style.left = `${Math.random() * 100}%`;
                el.style.bottom = '-2rem';
                el.style.animationName = 'iconRise';
                el.style.animationTimingFunction = 'ease-in-out';
                el.style.animationIterationCount = 'infinite';
                el.style.animationDelay = `${(Math.random() * 5).toFixed(2)}s`;
                const baseDuration = 10 + Math.random() * 10;
                el.style.animationDuration = `${(baseDuration / speedFactor).toFixed(2)}s`;
                bgContainer.appendChild(el);
            }
        })
        .catch(console.error);
}

window.mudarAnimacao = function(modo) {
    if (bgAnimationFrameId) {
        cancelAnimationFrame(bgAnimationFrameId);
        bgAnimationFrameId = null;
    }
    bgContainer.innerHTML = '';

    if (modo === 'original') {
        iniciarAnimacaoOriginal();
    } else {
        iniciarAnimacaoComColisao();
    }
}

// Inicia a animação de fundo preferida do usuário
const savedAnimation = localStorage.getItem('ld_bgAnimation') || 'colisao';
mudarAnimacao(savedAnimation);

</script>
{% endblock %}